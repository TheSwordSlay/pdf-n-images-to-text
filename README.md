# PDF Image Replacement API

A Flask API that processes PDF documents by replacing all images with descriptive text generated by OpenRouter's Gemini 2.5 Flash model. The API returns a new PDF file where images have been replaced with AI-generated descriptions, maintaining the document's text content and structure.

## Features

- **PDF Image Replacement**: Replaces images in PDFs with descriptive text
- **AI Image Description**: Uses OpenRouter's Gemini 2.5 Flash model to generate detailed descriptions of images
- **Language Detection**: Automatically detects document language and generates descriptions in the same language
- **Position-Aware Processing**: Maintains the relative positioning of text and image descriptions
- **Dual Output Modes**: Returns either a modified PDF file or JSON with extracted content
- **Dockerized**: Ready-to-deploy Docker container
- **Error Handling**: Comprehensive error handling and logging
- **File Size Limits**: Configurable file size limits (default: 16MB)

## Prerequisites

- Docker and Docker Compose
- OpenRouter API key (get one at [openrouter.ai](https://openrouter.ai))

## Quick Start

1. **Clone or create the project directory**
   ```bash
   mkdir pdf-image-replacement-api
   cd pdf-image-replacement-api
   ```

2. **Set up environment variables**
   ```bash
   cp .env.example .env
   # Edit .env and add your OpenRouter API key
   ```

3. **Build and run with Docker Compose**
   ```bash
   docker-compose up --build
   ```

4. **Test the API**
   ```bash
   curl http://localhost:5000/
   ```

## API Endpoints

### Health Check
- **GET** `/`
- Returns API status, version information, and available endpoints

### Convert PDF (Primary Endpoint)
- **POST** `/convert`
- **Content-Type**: `multipart/form-data`
- **Parameters**:
  - `file`: PDF file to process (max 16MB)
- **Returns**: Modified PDF file with images replaced by descriptive text

**Example Request:**
```bash
curl -X POST \
  -F "file=@your-document.pdf" \
  -o "output_with_descriptions.pdf" \
  http://localhost:5000/convert
```

**Response**: Downloads a PDF file where all images have been replaced with descriptive text boxes.

### Convert PDF to JSON (Legacy Endpoint)
- **POST** `/convert-json`
- **Content-Type**: `multipart/form-data`
- **Parameters**:
  - `file`: PDF file to process (max 16MB)
- **Returns**: JSON with extracted text and image descriptions

**Example Request:**
```bash
curl -X POST \
  -F "file=@your-document.pdf" \
  http://localhost:5000/convert-json
```

**Example Response:**
```json
{
  "success": true,
  "detected_language": "english",
  "merged_text": "--- Page 1 ---\nDocument text here...\n\n[IMAGE: A detailed description of the image generated by Gemini 2.5 Flash...]\n\n==================================================\n",
  "page_details": [
    {
      "page_number": 1,
      "text_blocks": [...],
      "images": [
        {
          "index": 0,
          "description": "A detailed description of the image...",
          "bbox": {...}
        }
      ]
    }
  ]
}
```

## Configuration

### Environment Variables

- `OPENROUTER_API_KEY`: Your OpenRouter API key (required)
- `FLASK_ENV`: Flask environment (development/production)
- `FLASK_DEBUG`: Enable Flask debug mode (True/False)

### Docker Configuration

The application runs on port 5000 inside the container and is mapped to port 5000 on the host.

## Development

### Local Development Setup

1. **Install Python dependencies**
   ```bash
   pip install -r requirements.txt
   ```

2. **Set up environment variables**
   ```bash
   cp .env.example .env
   # Add your OpenRouter API key to .env
   ```

3. **Run the application**
   ```bash
   python app.py
   ```

### Project Structure

```
pdf-image-replacement-api/
├── app.py                 # Main Flask application with PDF processing
├── requirements.txt       # Python dependencies (includes ReportLab)
├── Dockerfile            # Docker configuration
├── docker-compose.yml    # Docker Compose configuration
├── .env.example          # Environment variables template
├── test_api.py           # API testing script
└── README.md            # This file
```

## Key Changes from Previous Version

This version has been significantly updated to replace images in PDFs with descriptive text rather than just extracting content:

### What's New:
- **PDF Output**: The primary endpoint now returns a modified PDF file instead of JSON
- **Image Replacement**: Images are replaced with formatted text descriptions in the PDF
- **Language-Aware Descriptions**: AI descriptions are generated in the same language as the document
- **Position-Aware Layout**: Text and image descriptions maintain their relative positions
- **Dual Endpoints**: Both PDF output (`/convert`) and JSON output (`/convert-json`) are available

### Migration from v1.x:
- The `/convert` endpoint now returns a PDF file instead of JSON
- Use `/convert-json` if you need the old JSON response format
- The response structure for JSON endpoint has been updated with position information

## How It Works

1. **PDF Upload**: Client uploads a PDF file via the `/convert` endpoint
2. **Content Extraction**: PyMuPDF extracts text blocks and images with their positions from each page
3. **Language Detection**: AI analyzes the document text to detect the primary language
4. **Image Description**: Each image is sent to OpenRouter's Gemini 2.5 Flash model for description in the detected language
5. **PDF Generation**: A new PDF is created using ReportLab, replacing images with formatted text descriptions
6. **Response**: The API returns the modified PDF file for download

### For JSON Endpoint (`/convert-json`):
1. **PDF Upload**: Client uploads a PDF file via the `/convert-json` endpoint
2. **Content Extraction**: Same as above
3. **Language Detection**: Same as above
4. **Image Description**: Same as above
5. **Content Merging**: Text and image descriptions are merged maintaining positional order
6. **Response**: The API returns JSON with merged text and detailed page information

## Dependencies

- **Flask**: Web framework
- **PyMuPDF**: PDF processing and image extraction
- **ReportLab**: PDF creation and generation
- **Pillow**: Image processing
- **requests**: HTTP client for OpenRouter API
- **python-dotenv**: Environment variable management

## Error Handling

The API includes comprehensive error handling for:
- Missing or invalid files
- Unsupported file formats
- API key configuration issues
- OpenRouter API errors
- PDF processing errors
- File size limits

## Limitations

- Maximum file size: 16MB (configurable)
- Supported input format: PDF only
- Image formats: PNG, JPEG, and other formats supported by PyMuPDF
- Output PDF uses ReportLab formatting (may differ from original layout)
- Complex layouts with overlapping elements may not be perfectly preserved
- API rate limits depend on your OpenRouter plan
- Processing time depends on the number of images in the document

## Troubleshooting

### Common Issues

1. **"OpenRouter API key not configured"**
   - Ensure your `.env` file contains a valid `OPENROUTER_API_KEY`

2. **"File too large"**
   - The default limit is 16MB. Reduce file size or modify `MAX_CONTENT_LENGTH` in `app.py`

3. **Docker build fails**
   - Ensure Docker has sufficient memory allocated
   - Check internet connection for downloading dependencies

4. **Images not being described**
   - Verify your OpenRouter API key has sufficient credits
   - Check the logs for API error messages

5. **PDF generation fails**
   - Check if there are any special characters in the text that might cause issues
   - Verify that the ReportLab library is properly installed
   - Check the logs for specific PDF creation errors

6. **Output PDF layout differs from original**
   - This is expected behavior as the API recreates the PDF with a standardized layout
   - Complex layouts with precise positioning may not be perfectly preserved

### Logs

View application logs:
```bash
docker-compose logs -f pdf-to-text-api
```

## License

This project is open source and available under the MIT License.